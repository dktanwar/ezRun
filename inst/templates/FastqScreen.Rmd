---
title: "`r if (exists('reportTitle')) reportTitle else 'Fastq Screen'`"
author: "Functional Genomics Center Zurich"
output: 
  html_document:
    self_contained: false
    lib_dir: rmarkdownLib
    includes:
      in_header: fgcz_header.html
    css: fgcz.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(knitr)
require(kableExtra)
require(plotly)

output <- readRDS("output.rds")
param <- readRDS("param.rds")
input <- readRDS("input.rds")
rawScreenResult <- readRDS("rawScreenResult.rds")
procScreenResult <- readRDS("procScreenResult.rds")
virusResult <- readRDS("virusResult.rds")
refseqResult = readRDS("refseqResult.rds")
krakenResult <- readRDS("krakenResult.rds")
rRNAstrandResult <- readRDS("rRNAstrandResult.rds")
dataset = input$meta
samples = input$getNames()

debug <- FALSE
```
Started on `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

## FastqScreen_Result {.tabset}


### FastqScreen Mapping Rates to Adapters and rRNA
```{r overview plotly, fig.height=7, fig.width=min(max(7, 7+(length(samples)-20)*0.2), 30), echo=FALSE, warning=FALSE, message=FALSE}
m <- list(l = 80, r = 80, b = 200, t = 100, pad = 0) # more margin space

percentMapped = sapply(rawScreenResult, function(x){100 - x$"%Unmapped"})

# MappingRateAdapters
p <- plot_ly(x=samples,
             y=percentMapped,
             type="bar") %>%
  layout(title = "MappingRate to Adapters - Bowtie2, local Alignment",
         yaxis = list(title = "MappedReads in %", range = c(0,100)),
         margin = m)
p

# Reads
#p <- plot_ly(x=names(fastqData$Reads), y=fastqData$Reads/1e3, type="bar") %>%
#  layout(title = "ProcessedReads",
#         yaxis = list(title = "#Reads in K"),
#         margin = m)
#p

# rRNA Mapping
rRnaPercentMapped = rRNAstrandResult[ , c("Sense", "Antisense")] / rRNAstrandResult$`Read Count` * 100
rRnaPercentMapped$sample = rownames(rRnaPercentMapped)
p <- plot_ly(rRnaPercentMapped, x=~sample, y=~Sense, 
             type="bar", name="sense") %>%
    add_trace(y = ~Antisense, name = "antisense") %>%
  layout(title = "rRNA Silva Mapping - Bowtie2, end-to-end Alignment",
         yaxis = list(title = "rRNA-Mapping-Rate in %"),
         xaxis = list(title = ""),
         barmode = 'stack', margin = m)
p
```

### FastqScreen Mapping Per Sample

```{r FastqScreenPerSample, echo=FALSE, results='hide', warning=FALSE, message=FALSE, eval=!debug}
for (nm in samples){
  par(mar=c(10.1, 4.1, 4.1, 2.1))
  x = procScreenResult[[nm]][ , c("%One_hit_one_genome", "%Multiple_hits_one_genome", 
                                  "%One_hit_multiple_genomes", "%Multiple_hits_multiple_genomes")]
  if (nrow(x) > 0){
    x = x[ , c("%One_hit_one_genome", "%Multiple_hits_one_genome", 
                                  "%One_hit_multiple_genomes", "%Multiple_hits_multiple_genomes")]
    bplt = barplot(t(x), las=2, ylim=c(0,100), 
                   legend.text=T, ylab="Mapped Reads in %", main=nm, names.arg=rep('', nrow(x)))
      text(x = bplt, y = par("usr")[3] - 2, srt = 45, adj = 1, labels = rownames(x), xpd = TRUE)
  } else {
    plot(1,1, type="n", axes=FALSE, main=nm, xlab="", ylab="", frame=TRUE)
    text(1,1, "no hits found")
  }
}
```

### Mapping to RefSeq mRNA Per Sample

```{r mRNAPerSample, echo=FALSE, results='hide', warning=FALSE, message=FALSE, eval=!debug}
for (nm in samples){
      par(mar=c(10.1, 4.1, 4.1, 2.1))
      x = refseqResult[[nm]]
      if (is.null(x)) x = matrix(0, 2, 1, dimnames=list(c('UniqueSpeciesHits','MultipleSpeciesHits'),'Misc'))
      bplot = barplot(t(x), col=c("royalblue3", "lightblue"), las=2, ylim=c(0,100),
                      legend.text=T, ylab="Mapped Reads in %", main=nm, names.arg=rep('',nrow(x)) )
      text(y=t(x)[ 1,] + 5, x=bplot, font = 2, labels=t(x)[ 1, ], cex=1.1, col='black')
      text(x = bplot, y = par("usr")[3] - 2, srt = 45, adj = 1, 
           labels = rownames(x), xpd = TRUE)
}
```

### Mapping to Genomes with Kraken

Abundances above 5% are truncated.

```{r KrakenPerSample, echo=FALSE, results='hide', warning=FALSE, message=FALSE, eval=!debug}
for (nm in samples){
  x = krakenResult[[nm]]
  par(mar=c(15.1, 4.1, 4.1, 2.1))
  bplot = barplot(x$readPercentage, names.arg = x$name, col = 'royalblue3', 
                  main = nm, ylab = 'Mapped Reads in %', las = 2, ylim=c(0, 5))
}
```

### Virus Check

```{r virus, echo=FALSE, results='hide', warning=FALSE, message=FALSE, eval=!debug}
if(param[['virusCheck']]){
  for (nm in samples){ 
    par(mar=c(18.1, 7.1, 2.1, 2.1))
    x = virusResult[[nm]]
    if (is.null(x)) x = matrix(0, 2, 1, dimnames=list(c('UniqueSpeciesHits','MultipleSpeciesHits'),'Misc'))
    bplot = barplot(t(x), col=c("royalblue3", "lightblue"), las = 2, ylim = c(0,100),
                    legend.text=T, ylab="Mapped Reads in %", main=nm, names.arg=rep('',nrow(x)) )
    text(y=t(x)[ 1,] + 5, x=bplot, font = 2, labels=t(x)[ 1, ], cex = 1.1, col = 'black')
    text(x = bplot, y = par("usr")[3] - 2, srt = 60, adj = 1, 
         labels = rownames(x), xpd = TRUE)
  }
} else {
  cat("not run")
}
```


### RIN

#### RIN vs Read Count
```{r rin1, echo=FALSE, message=FALSE, warning=FALSE}
if (nrow(dataset) > 1){
  rinCol <- colnames(dataset)[grep('^RIN', colnames(dataset))]
  if(length(rinCol) == 1){
    a <- makeScatterplot(dataset, colname1 = rinCol, colname2='Read Count')
    a
  }
}
```

#### RIN vs LibConc
```{r rin2, echo=FALSE, message=FALSE, warning=FALSE}
if (nrow(dataset) > 1){
  rinCol <- colnames(dataset)[grep('^RIN', colnames(dataset))]
  if(length(rinCol) == 1){
    libQuant <- colnames(dataset)[grep('LibConc_100_800bp', colnames(dataset))]  
    if(length(libQuant) == 1){
      b <- makeScatterplot(dataset, colname1 = rinCol, colname2=libQuant)
      b
    }
  }
}
```

#### RIN vs rRNA content
```{r rin3, echo=FALSE, message=FALSE, warning=FALSE}
if (nrow(dataset) > 1){
  rinCol <- colnames(dataset)[grep('RIN', colnames(dataset))]
  if(length(rinCol) == 1){
    dataset[['rRNA_Content']] <- rRNAstrandResult$Sense + rRNAstrandResult$Antisense
    c <- makeScatterplot(dataset, colname1 = rinCol, colname2='rRNA_Content')
    c
  }
}
```

### Settings
```{r setting, echo=FALSE}
getAppVer <- function(appName) { sub("^.+/([^/]+)$", "\\1", Sys.getenv(appName)) }
settings = character()
settings["Configuration File:"] = param$confFile
settings["RefSeq mRNA Reference:"] = REFSEQ_mRNA_REF
settings["FastqScreen Version:"] = getAppVer("FastQScreen")
settings["Bowtie2 Version:"] = getAppVer("Bowtie2")
settings["Bowtie2 Parameters:"] = param$cmdOptions
settings["Minimum AlignmentScore:"] = param$minAlignmentScore
settings["TopSpecies:"] = param$nTopSpecies
kable(as.data.frame(settings), col.names=NA, row.names=TRUE, format="html") %>%
  kable_styling(bootstrap_options = "striped", full_width = F,
                position = "left")
```

### Input Dataset
```{r, echo=FALSE, message=FALSE}
ezInteractiveTableRmd(values=dataset)
```

### SessionInfo
```{r, echo=FALSE}
sessionInfo()
```

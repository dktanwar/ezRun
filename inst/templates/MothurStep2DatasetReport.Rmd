---
title: "`r paste('Mothur data analysis report: chimeras, clustering, and phyloseq analysis')`"
author: "Functional Genomics Center Zurich"
output: 
  html_document:
    self_contained: false
    includes:
      in_header: fgcz_header.html
    css: fgcz.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## This report requires summary files form mothur
debug <- FALSE
setEnvironments("phantomjs")
```

```{r prepare data for mothur analysis report, include=FALSE}
### raw data summary tables
summaryTablesToReport <- grep("Summary",names(listOfListAllFiles), value = T)
summaryTablesToReport <- grep("stepConvergence", summaryTablesToReport, invert = T, value = T)
summaryTablesToReport <- listOfListAllFiles[summaryTablesToReport]

finalListOfSummaryTables <- imap(summaryTablesToReport,function(x,y)
  createSummaryTableForKableExtra(x))

### stepsData
convStepTableToReport <- imap(listOfListAllFiles["stepConvergenceSummary"], function(x,y) createStepConvTableForKableExtra(x))

### OTU saturation plots
otuSaturPlotToReport <- otuSaturationPlot(listOfListAllFiles["OTUsCountTable"]$OTUsCountTable)

### OTU saturation table 
otuSaturationTableToReport <- imap(listOfListAllFiles["OTUsCountTable"], function(x,y) createSaturationTableForKableExtra(x)) 

### Chimera plot
chimeraPlotsToReport <- chimeraSummaryPlot(listOfListAllFiles["ChimeraPlot"]$ChimeraPlot)
```

```{r prepAbund, include=FALSE}
### create plots: 1. abundance
abundPlot <- plot_bar(physeqFullObject, fill="Phylum") + geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")
if (isGroupThere) {
  abundPlotGroup <- plot_bar(physeqFullObject, "Order", fill="Phylum", facet_grid=~Group) +
    geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack") +
    theme(axis.title.x = element_blank(),axis.text.x =  element_blank())
}
```

```{r prepOrdTaxa, include=FALSE, eval=isGroupThere}
### create plots: 2. ordination by taxa 
ordinateDS <- ordinate(physeqFullObject, "NMDS", "bray")
plotOrdTaxa = plot_ordination(physeqFullObject, ordinateDS, type="taxa", color="Phylum") + facet_wrap(~Phylum, 3) + ggtitle("Taxa ordination") + theme(legend.position = "none")
```

```{r prepOrdSamples, include=FALSE, eval=isGroupThere}
### create plots: 2. ordination by samlpe
inputData <- physeqFullObject@otu_table@.Data
inputGroup <- physeqFullObject@sam_data$Group
plotOrdSamples =  pcaForPhylotseqPlot(inputData,inputGroup) + ggtitle("Sample ordination")
```

```{r prepRich, include=FALSE}
### create plots: 3. richness 
if (isGroupThere) {
plotRichness <- plot_richness(physeqFullObject, x="Group", measures=c("Simpson", "Shannon"), color="Group")
}else{
plotRichness <- plot_richness(physeqFullObject, measures=c("Simpson", "Shannon"))
}
```

```{r prepTree, include=FALSE}
### create plots: 4. tree
if (isGroupThere) {
plotTree <- plot_tree(physeqFullObject , ladderize="left", color="Group")
}else{
plotTree <- plot_tree(physeqFullObject , ladderize="left")
}
```

```{r prepHeat, include=FALSE, eval=isGroupThere}
### create plots:5. heatmap
#TODO: marigns too large
#inputData <- physeqFullObject@otu_table@.Data
#plotHeatmap <- heatmapForPhylotseqPlot(inputData)
plotHeatmap <- plot_heatmap(physeqFullObject, taxa.label="Phylum")
```


```{r prepDeSeq, include=FALSE, eval=isGroupThere}
### 6: compare groups
deseqResults <- phyloSeqToDeseq2_tableAndPlots(physeqFullObject)
```

Started on `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

## Data pre-processing {.tabset}
### Mothur data analysis: summary of the  reads filtered by mapping
```{r MapFiltSummary, echo=FALSE}
kable(finalListOfSummaryTables["MapFiltSummary"]$MapFiltSummary$mergedTable, escape=TRUE, row.names=FALSE, format="html") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"),
                full_width = T) %>%
  group_rows(index = finalListOfSummaryTables["MapFiltSummary"]$MapFiltSummary$aboveHeader) %>%
  scroll_box(width = "100%", height = "600px")
```

### Mothur data analysis: summary of the reads preclustered and filtered for chimeras
```{r,echo=FALSE, out.width="100%"}
  plot(chimeraPlotsToReport)
```

### Mothur data analysis: OTUs convergence summary
```{r stepConvergence, echo=FALSE}
kable(convStepTableToReport["stepConvergenceSummary"]$stepConvergenceSummary$mergedTable, escape=TRUE, row.names=FALSE, format="html") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"),
                full_width = T) %>%
  group_rows(index = convStepTableToReport["stepConvergenceSummary"]$stepConvergenceSummary$aboveHeader) %>%
  scroll_box(width = "100%", height = "600px")
```

### Mothur data analysis: OTUs saturation plots
```{r,echo=FALSE, out.width="100%"}
  plot(otuSaturPlotToReport)
```

### Phyloseq analysis: abundance barplots
#### If samples are grouped, the second plot is more informative
```{r abund, echo=FALSE,out.width="100%"}
plot(abundPlot)
```

```{r abundGroup, echo=FALSE,out.width="100%",eval=isGroupThere}
plot(abundPlotGroup)
```

### Phyloseq analysis: clustering (ordination) plots
```{r ordinTaxa, echo=FALSE,eval=isGroupThere,out.width="100%"}
plot(plotOrdTaxa)
```

```{r ordinSamples, echo=FALSE, eval=isGroupThere,out.width="100%"}
plot(plotOrdSamples)
```

### Phyloseq analysis: richness plots
```{r rich, echo=FALSE,out.width="100%"}
plot(plotRichness)
```

```{r tree, echo=FALSE,out.width="100%", eval=FALSE}
plot(plotTree)
```

### Phyloseq analysis: heatmaps
```{r heat, echo=FALSE,out.width="100%",eval=isGroupThere}
## if alternativenot fixed, use phyloseq method
plot_heatmap(physeqFullObject, sample.label="Group")
#plot(plotHeatmap)
#show_heatmap <- heatmapForPhylotseqPlot(physeqFullObject@otu_table@.Data)
#show_heatmap()
```

### Phyloseq analysis: two-goups comparison
```{r volcano, echo=FALSE,eval=isGroupThere,out.width="100%"}
plot(deseqResults$vPlot)
```

```{r logfold, echo=FALSE,eval=isGroupThere,out.width="100%"}
plot(deseqResults$logPlot)
```

```{r diffAbunGen, echo=FALSE,eval=isGroupThere,out.width="100%"}
plot(deseqResults$pieChart)
```

#### DESeq analysis: summary table (top 20 differentially expressed organisms)
```{r deSeqTable, echo=FALSE,eval=isGroupThere,out.width="100%"}
kable(deseqResults$table, escape=TRUE, row.names=FALSE, format="html") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"),
                full_width = T) %>%
  scroll_box(width = "100%", height = "600px")
```

### SessionInfo
```{r, echo=FALSE}
sessionInfo()
```

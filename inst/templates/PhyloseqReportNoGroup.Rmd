---
title: "`r paste('Analysis of 16S data: phyloseq report')`"
author: "Functional Genomics Center Zurich"
output: 
  html_document:
    self_contained: false
    includes:
      in_header: fgcz_header.html
    css: fgcz.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE, message=FALSE, out.width = "49%")
## This report requires summary files form mothur
debug <- FALSE
setEnvironments("phantomjs")
```

```{r prepAbund, include=FALSE}
### create plots: 1. abundance
abundPlot <- plot_bar(physeqFullObject, fill="Genus") + geom_bar(aes(fill=Genus), stat="identity", position="stack")
```

```{r prepOrdTaxa, include=FALSE}
### create plots: 2. ordination by taxa 
ordinateDS <- ordinate(physeqFullObject, "NMDS", "bray")
plotOrdTaxa = plot_ordination(physeqFullObject, ordinateDS, type="taxa", color="Phylum") + facet_wrap(~Phylum, 3) + ggtitle("Taxa ordination") + theme(legend.position = "none") 
```


```{r prepRich, include=FALSE}
### create plots: 3. richness 
plotRichness <- plot_richness(physeqFullObject, measures=c("Simpson", "Shannon"))
```

```{r prepTree, include=FALSE}
### create plots: 4. tree
plotTree <- plot_tree(physeqFullObject , ladderize="left")
```

```{r prepRaref, include=FALSE}
### create plots: 4. tree
taxDF <- data.frame(physeqObjectNoTree@tax_table@.Data, stringsAsFactors = F)
otuDF <- data.frame(physeqObjectNoTree@otu_table@.Data, stringsAsFactors = F)
specList <- list()
for (taxon in colnames(taxDF)){
genusOTUs <- rownames(taxDF)[grep("unclass",taxDF[[taxon]], invert = T)]
if (length(genusOTUs) >0){
specDF <- otuDF[,genusOTUs]
specDF$Group <- as.factor(rownames(specDF))
specDF$Taxon <- as.factor(taxon)
specList[[taxon]] <- specDF
}
}
finalSpecList <- do.call("rbind",specList)
rarefPlot <- otuSaturationPlot(finalSpecList,"table")
```

Started on `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

## Phyloseq report {.tabset}
### Abundance barplots
#### If samples are grouped, the second plot  is more informative
```{r abund, echo=FALSE}
plot(abundPlot)
```

### Richness plots
```{r rich, echo=FALSE,out.width="60%"}
plot(plotRichness)
```

### Rarefaction plots
```{r raref, echo=FALSE, eval=FALSE}
plot(rarefPlot)
```

### SessionInfo
```{r, echo=FALSE}
sessionInfo()
```
